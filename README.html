<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Rick Dean">
<meta name="dcterms.date" content="2025-01-21">

<title>RcensusPkg Examples</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="README_files/libs/clipboard/clipboard.min.js"></script>
<script src="README_files/libs/quarto-html/quarto.js"></script>
<script src="README_files/libs/quarto-html/popper.min.js"></script>
<script src="README_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="README_files/libs/quarto-html/anchor.min.js"></script>
<link href="README_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="README_files/libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="README_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="README_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="README_files/libs/bootstrap/bootstrap-8a79a254b8e706d3c925cde0a310d4f0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="README.md"><i class="bi bi-file-code"></i>Github (GFM)</a></li></ul></div></div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">RcensusPkg Examples</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Rick Dean </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 21, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Accessing the US Census Bureau’s database of survey data and map geometries via their API can be a challenge. The developer is faced with the Bureau’s many <a href="https://www.census.gov/data/developers/data-sets.html">datasets</a> and collection of <a href="https://www.census.gov/programs-surveys/geography/technical-documentation/complete-technical-documentation/tiger-geo-line.html">TIGER/Line Shapefiles</a>. The R package <a href="https://github.com/deandevl/RcensusPkg">RcensusPkg</a> can help by providing specific functions for checking on the availability of geographies, variables, datasets, and dates. In addition, the package provides easy access to the Bureau’s extensive Tiger Line map geometries and for joining the maps with Census Bureau survey data. Presented here is a basic step-by-step work flow in acquiring survey data and producing choropleth maps.</p>
</section>
<section id="example-and-workflow" class="level2">
<h2 class="anchored" data-anchor-id="example-and-workflow">Example and workflow</h2>
<p>The example presented here compares the percentage of computer presence across the states in 2013 with 2023. The workflow involves the following steps:</p>
<ol type="1">
<li><p>What is the dataset name recognized by the Bureau’s API that contain computer related variables.</p></li>
<li><p>From the dataset, what are the variable acronyms that address the percentage of computer presence.</p></li>
<li><p>The years or “vintage” of interest available from the dataset should also be checked. A “404 error, data not found” if the year is not available.</p></li>
<li><p>A dataset has a “region” or geography for which it was created. We should make sure that the “region” of interest is available from the dataset.</p></li>
<li><p>With names for dataset, variables, region, and year we should be able to make an error free data request.</p></li>
<li><p>Download the TIGER/Line Shapefile geometries for the “region” and merge it with the data. The result should be a simple feature object ready for plotting.</p></li>
<li><p>Create a choropleth map from the simple feature object.</p></li>
</ol>
</section>
<section id="installation" class="level2">
<h2 class="anchored" data-anchor-id="installation">Installation</h2>
<p>You can install the development version of RcensusPkg from <a href="https://github.com/">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("pak")</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>pak<span class="sc">::</span><span class="fu">pak</span>(<span class="st">"deandevl/RcensusPkg"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Using <code>devtools::install_github()</code>:</p>
<p><code>devtools::install_github("deandevl/RcensusPkg")</code></p>
<p>Also for the Example: <code>devtools::install_github("deandevl/RplotterPkg")</code></p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>We will be using the following packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(withr)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RplotterPkg)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RcensusPkg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="identify-the-dataset-and-variables-related-to-computers" class="level2">
<h2 class="anchored" data-anchor-id="identify-the-dataset-and-variables-related-to-computers">Identify the dataset and variables related to “computers”</h2>
<p>We are starting from ground zero where we know little about the availability of Census Bureau data as they relate to “computers”. <code>RcensusPkg</code> has consolidated the Bureau’s dataset names into 7 groupings or categories. We can search the categories for a dataset’s label string and access its collection of variables using <code>RcensusPkg::get_variable_names()</code>.</p>
<p>Start by searching datasets under category “acs1” for the year 2023 and dataset labels containing the phrase “computers”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>variables_2023_dt <span class="ot">&lt;-</span> RcensusPkg<span class="sc">::</span><span class="fu">get_variable_names</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">category =</span> <span class="st">"acs1"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">vintage =</span> <span class="dv">2023</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">filter_label_str =</span> <span class="st">"computers"</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looking at rows 44 to 49 out of 55 of <code>variables_2023_dt</code>:</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Table 1: 2023 Census Bureau ‘computers’ variables</caption>
<colgroup>
<col style="width: 9%">
<col style="width: 76%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: left;">label</th>
<th style="text-align: left;">dataset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">DP02_0152E</td>
<td style="text-align: left;">Estimate!!COMPUTERS AND INTERNET USE!!Total households</td>
<td style="text-align: left;">acs/acs1/profile</td>
</tr>
<tr class="even">
<td style="text-align: left;">DP02_0152PE</td>
<td style="text-align: left;">Percent!!COMPUTERS AND INTERNET USE!!Total households</td>
<td style="text-align: left;">acs/acs1/profile</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DP02_0153E</td>
<td style="text-align: left;">Estimate!!COMPUTERS AND INTERNET USE!!Total households!!With a computer</td>
<td style="text-align: left;">acs/acs1/profile</td>
</tr>
<tr class="even">
<td style="text-align: left;">DP02_0153PE</td>
<td style="text-align: left;">Percent!!COMPUTERS AND INTERNET USE!!Total households!!With a computer</td>
<td style="text-align: left;">acs/acs1/profile</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DP02_0154E</td>
<td style="text-align: left;">Estimate!!COMPUTERS AND INTERNET USE!!Total households!!With a broadband Internet subscription</td>
<td style="text-align: left;">acs/acs1/profile</td>
</tr>
<tr class="even">
<td style="text-align: left;">DP02_0154PE</td>
<td style="text-align: left;">Percent!!COMPUTERS AND INTERNET USE!!Total households!!With a broadband Internet subscription</td>
<td style="text-align: left;">acs/acs1/profile</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>From the first category, “acs1” we have addressed our first three steps:</p>
<ul>
<li><p>dataset: “acs/acs1/profile” <a href="https://www.census.gov/data/developers/data-sets/acs-1year.html">Data Profiles</a></p></li>
<li><p>vintage: 2023</p></li>
<li><p>variable acronym: “DP02_0153PE” <em>Percent!!COMPUTERS AND INTERNET USE!!Total households!!With a computer</em></p></li>
</ul>
<p>Let us check the availability of variable “DP02_0153PE” for vintage 2013 using <code>RcensusPkg::get_variable_names()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>variables_2013_dt <span class="ot">&lt;-</span> RcensusPkg<span class="sc">::</span><span class="fu">get_variable_names</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"acs/acs1/profile"</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">"DP02_0153PE"</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">vintage =</span> <span class="dv">2013</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our result is 0 observations for <code>variables_2013_dt</code>. Evidently the Census Bureau API’s acronym name has changed and “DP02_0153PE” does not exists for 2013.</p>
<p>Let’s do another category search for “computers” and 2013:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>variables_2013_dt <span class="ot">&lt;-</span> RcensusPkg<span class="sc">::</span><span class="fu">get_variable_names</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">category =</span> <span class="st">"acs1"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">vintage =</span> <span class="dv">2013</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">filter_label_str =</span> <span class="st">"computers"</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fifty rows are returned and there is a “percentage of computers” variable – just a different acronym name of “DP02_0151PE”:</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Table 2: 2013 Census Bureau ‘computers’ variables</caption>
<colgroup>
<col style="width: 9%">
<col style="width: 76%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: left;">label</th>
<th style="text-align: left;">dataset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">DP02_0150E</td>
<td style="text-align: left;">Estimate!!COMPUTERS AND INTERNET USE!!Total Households</td>
<td style="text-align: left;">acs/acs1/profile</td>
</tr>
<tr class="even">
<td style="text-align: left;">DP02_0150PE</td>
<td style="text-align: left;">Percent!!COMPUTERS AND INTERNET USE!!Total Households</td>
<td style="text-align: left;">acs/acs1/profile</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DP02_0151E</td>
<td style="text-align: left;">Estimate!!COMPUTERS AND INTERNET USE!!Total Households!!With a computer</td>
<td style="text-align: left;">acs/acs1/profile</td>
</tr>
<tr class="even">
<td style="text-align: left;">DP02_0151PE</td>
<td style="text-align: left;">Percent!!COMPUTERS AND INTERNET USE!!Total Households!!With a computer</td>
<td style="text-align: left;">acs/acs1/profile</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DP02_0152E</td>
<td style="text-align: left;">Estimate!!COMPUTERS AND INTERNET USE!!Total Households!!With a broadband Internet subscription</td>
<td style="text-align: left;">acs/acs1/profile</td>
</tr>
<tr class="even">
<td style="text-align: left;">DP02_0152PE</td>
<td style="text-align: left;">Percent!!COMPUTERS AND INTERNET USE!!Total Households!!With a broadband Internet subscription</td>
<td style="text-align: left;">acs/acs1/profile</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We now have the following:</p>
<ul>
<li><p>dataset: “acs/acs1/profile”</p></li>
<li><p>vintages: 2013, 2023</p></li>
<li><p>variable acronyms: “DP02_0151PE”(2013), “DP02_0153PE”(2023)</p></li>
</ul>
</section>
<section id="check-the-availability-of-state-geography" class="level2">
<h2 class="anchored" data-anchor-id="check-the-availability-of-state-geography">Check the availability of state geography</h2>
<p>Step 4 checks geography – we need estimates at the state level. To address geography we can use <code>RcensusPkg::get_geography()</code>.</p>
<p>Get the available geography levels for dataset “acs/acs1/profile” and vintage 2023:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>geography_dt <span class="ot">&lt;-</span> RcensusPkg<span class="sc">::</span><span class="fu">get_geography</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"acs/acs1/profile"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">vintage =</span> <span class="dv">2023</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Among the 19 levels returned, “state” is listed:</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Table 3: 2023 Census Bureau geography levels for ‘acs/acs1/profile’</caption>
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">us</td>
</tr>
<tr class="even">
<td style="text-align: left;">region</td>
</tr>
<tr class="odd">
<td style="text-align: left;">division</td>
</tr>
<tr class="even">
<td style="text-align: left;">state</td>
</tr>
<tr class="odd">
<td style="text-align: left;">county</td>
</tr>
<tr class="even">
<td style="text-align: left;">county subdivision</td>
</tr>
<tr class="odd">
<td style="text-align: left;">place</td>
</tr>
<tr class="even">
<td style="text-align: left;">alaska native regional corporation</td>
</tr>
<tr class="odd">
<td style="text-align: left;">american indian area/alaska native area/hawaiian home land</td>
</tr>
<tr class="even">
<td style="text-align: left;">metropolitan statistical area/micropolitan statistical area</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>A similar result is returned for 2013.</p>
</section>
<section id="request-the-census-bureau-data" class="level2">
<h2 class="anchored" data-anchor-id="request-the-census-bureau-data">Request the Census Bureau data</h2>
<p>Using <code>RcensusPkg::get_vintage_data()</code> we request the percentage of household computers across the states for 2013 and 2023. As stated in the help for this function, the Census Bureau API data requests require an access key. Sign-up for a key is free and can be obtained <a href="https://api.census.gov/data/key_signup.html">here</a>. The function will check for a global setting of the key via <code>Sys.getenv("CENSUS_KEY")</code>. Run <code>usethis::edit_r_environ()</code> and edit your .Renviron file with the line: CENSUS_KEY=<em>your key</em> to create the global association.</p>
<p>For 2013:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>computers_2013_dt <span class="ot">&lt;-</span> RcensusPkg<span class="sc">::</span><span class="fu">get_vintage_data</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"acs/acs1/profile"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">vintage =</span> <span class="dv">2013</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> <span class="st">"DP02_0151PE"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">region =</span> <span class="st">"state:*"</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Rename columns, select columns, convert values to numeric, order the rows by “State”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>computers_2013_dt <span class="ot">&lt;-</span> computers_2013_dt <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setnames</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">old =</span> <span class="fu">c</span>(<span class="st">"NAME"</span>, <span class="st">"DP02_0151PE"</span>),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">new =</span> <span class="fu">c</span>(<span class="st">"State"</span>, <span class="st">"ComputerPresent"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  _[, .(GEOID, State, ComputerPresent)] <span class="sc">|&gt;</span> </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  _[, ComputerPresent <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(ComputerPresent)] <span class="sc">|&gt;</span>  </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  _[<span class="fu">order</span>(State)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Table 4: 2013 Census Bureau state percentage of computers</caption>
<thead>
<tr class="header">
<th style="text-align: left;">GEOID</th>
<th style="text-align: left;">State</th>
<th style="text-align: right;">ComputerPresent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: left;">Alabama</td>
<td style="text-align: right;">77.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">02</td>
<td style="text-align: left;">Alaska</td>
<td style="text-align: right;">90.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">04</td>
<td style="text-align: left;">Arizona</td>
<td style="text-align: right;">84.4</td>
</tr>
<tr class="even">
<td style="text-align: left;">05</td>
<td style="text-align: left;">Arkansas</td>
<td style="text-align: right;">77.8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">06</td>
<td style="text-align: left;">California</td>
<td style="text-align: right;">86.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">08</td>
<td style="text-align: left;">Colorado</td>
<td style="text-align: right;">89.3</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>For 2023:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>computers_2023_dt <span class="ot">&lt;-</span> RcensusPkg<span class="sc">::</span><span class="fu">get_vintage_data</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"acs/acs1/profile"</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">vintage =</span> <span class="dv">2023</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> <span class="st">"DP02_0153PE"</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">region =</span> <span class="st">"state:*"</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Repeat the <code>data.table</code> wrangling:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>computers_2023_dt <span class="ot">&lt;-</span> computers_2023_dt <span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">setnames</span>(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">old =</span> <span class="fu">c</span>(<span class="st">"NAME"</span>, <span class="st">"DP02_0153PE"</span>),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">new =</span> <span class="fu">c</span>(<span class="st">"State"</span>, <span class="st">"ComputerPresent"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  _[, .(GEOID, State, ComputerPresent)] <span class="sc">|&gt;</span> </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  _[, ComputerPresent <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(ComputerPresent)] <span class="sc">|&gt;</span>  </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  _[<span class="fu">order</span>(State)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Table 5: 2023 Census Bureau state percentage of computers</caption>
<thead>
<tr class="header">
<th style="text-align: left;">GEOID</th>
<th style="text-align: left;">State</th>
<th style="text-align: right;">ComputerPresent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: left;">Alabama</td>
<td style="text-align: right;">94.6</td>
</tr>
<tr class="even">
<td style="text-align: left;">02</td>
<td style="text-align: left;">Alaska</td>
<td style="text-align: right;">97.4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">04</td>
<td style="text-align: left;">Arizona</td>
<td style="text-align: right;">97.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">05</td>
<td style="text-align: left;">Arkansas</td>
<td style="text-align: right;">95.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">06</td>
<td style="text-align: left;">California</td>
<td style="text-align: right;">97.2</td>
</tr>
<tr class="even">
<td style="text-align: left;">08</td>
<td style="text-align: left;">Colorado</td>
<td style="text-align: right;">97.7</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="merge-the-data-with-the-tigerline-shapefile-state-geometries" class="level2">
<h2 class="anchored" data-anchor-id="merge-the-data-with-the-tigerline-shapefile-state-geometries">Merge the data with the TIGER/Line Shapefile state geometries</h2>
<p>Using <code>RcensusPkg::plot_us_data()</code> we can download the Tiger geometries for the United States, merge the above data with the states, and produce a choropleth map. The only additional requirement for the function is that we specify a tempory folder to receive the shapefile files.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>shapefiles_folder <span class="ot">&lt;-</span> withr<span class="sc">::</span><span class="fu">local_tempdir</span>()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(shapefiles_folder)){</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(shapefiles_folder)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For 2013:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>computers_2013_lst <span class="ot">&lt;-</span> RcensusPkg<span class="sc">::</span><span class="fu">plot_us_data</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> computers_2013_dt[<span class="sc">!</span>(State <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Alaska"</span>,<span class="st">"Hawaii"</span>,<span class="st">"Puerto Rico"</span>)),],</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">states_col =</span> <span class="st">"State"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">value_col =</span> <span class="st">"ComputerPresent"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_dir =</span> shapefiles_folder,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale_breaks =</span> <span class="fu">seq</span>(<span class="dv">70</span>,<span class="dv">100</span>,<span class="dv">5</span>),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale_labels =</span> <span class="fu">seq</span>(<span class="dv">70</span>,<span class="dv">100</span>,<span class="dv">5</span>),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale_limits =</span> <span class="fu">c</span>(<span class="dv">70</span>,<span class="dv">100</span>),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend_key_width =</span> <span class="dv">1</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">display_plot =</span> <span class="cn">FALSE</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For 2023:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>computers_2023_lst <span class="ot">&lt;-</span> RcensusPkg<span class="sc">::</span><span class="fu">plot_us_data</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> computers_2023_dt[<span class="sc">!</span>(State <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Alaska"</span>,<span class="st">"Hawaii"</span>,<span class="st">"Puerto Rico"</span>)),],</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">states_col =</span> <span class="st">"State"</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">value_col =</span> <span class="st">"ComputerPresent"</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_dir =</span> shapefiles_folder,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale_breaks =</span> <span class="fu">seq</span>(<span class="dv">70</span>,<span class="dv">100</span>,<span class="dv">5</span>),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale_labels =</span> <span class="fu">seq</span>(<span class="dv">70</span>,<span class="dv">100</span>,<span class="dv">5</span>),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale_limits =</span> <span class="fu">c</span>(<span class="dv">70</span>,<span class="dv">100</span>),</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend_key_width =</span> <span class="dv">1</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">display_plot =</span> <span class="cn">FALSE</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>RcensusPkg::plot_us_data()</code> returns a list providing both a <code>ggplot2</code> plot and the simple feature object on which the plot is based.</p>
</section>
<section id="plot-the-choropleth-maps" class="level2">
<h2 class="anchored" data-anchor-id="plot-the-choropleth-maps">Plot the choropleth maps</h2>
<p>Our final step is to produce choropleth maps where we compare 2013 with 2023.</p>
<p>Using <code>RplotterPkg::multi_panel_grid()</code> we can combine the maps into one panel for making a comparison:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>plot_lst <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  computers_2013_lst<span class="sc">$</span>plots<span class="sc">$</span>lower_48, </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  computers_2023_lst<span class="sc">$</span>plots<span class="sc">$</span>lower_48</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>layout <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">plots =</span> plot_lst,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">rows =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">cols =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>RplotterPkg<span class="sc">::</span><span class="fu">multi_panel_grid</span>(</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">layout =</span> layout,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">cell_width =</span> <span class="dv">20</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">cell_height =</span> <span class="dv">14</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Computers Present 2013 - 2023"</span>,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot_titles =</span> <span class="fu">c</span>(<span class="st">"Year: 2013"</span>,<span class="st">"Year:2023"</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="README_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="1728"></p>
<figcaption>Figure 1: Percent of Computers Present in 2013/2023</figcaption>
</figure>
</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>